<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>동탄의 날씨</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1 { font-size: 1.8em; }
    .loading { font-weight: bold; color: gray; }
    .section { margin-top: 20px; }
  </style>
</head>
<body>
  <h1>동탄의 날씨</h1>
  <div class="loading" id="loading">날씨 정보를 불러오는 중...(3~4분 소요 예정)</div>
  <div id="weather-summary" class="section"></div>
  <div id="weather-detail" class="section"></div>

  <script>
    const serviceKey = 'UX0oUh7ZWRuQW2qnng2rzw8U14zs2TmY9DYi8Eqs0SDQpo1wMe0l/BtVqaYcl7LYEJP0wysrk3xmQFgeE5iTJQ==';
    const dustApiKey = 'UX0oUh7ZWRuQW2qnng2rzw8U14zs2TmY9DYi8Eqs0SDQpo1wMe0l/BtVqaYcl7LYEJP0wysrk3xmQFgeE5iTJQ==
';

    const date = new Date();
    const baseDate = date.toISOString().slice(0, 10).replace(/-/g, '');
    const dustDate = date.toISOString().slice(0, 10);

    const summaryTimes = ['0600', '0900', '1200', '1500', '1800'];
    const detailTimes = ['0100','0400','0700','1000','1300','1600','1900','2200'];

    const icons = {
      '맑음': 'sunny.png',
      '구름 많음': 'cloudy.png',
      '흐림': 'overcast.png',
      '비': 'rain.png',
      '눈': 'snow.png'
    };

    const cached = localStorage.getItem('weatherCache');
    if (cached) {
      const { date: savedDate, data } = JSON.parse(cached);
      if (savedDate === baseDate) {
        render(data);
      }
    }

    Promise.all([
      fetch(`https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst?serviceKey=${serviceKey}&numOfRows=200&pageNo=1&dataType=JSON&base_date=${baseDate}&base_time=0500&nx=61&ny=120`),
      fetch(`https://apis.data.go.kr/B552584/ArpltnInforInqireSvc/getMsrstnAcctoRltmMesureDnsty?serviceKey=${dustApiKey}&returnType=json&stationName=동탄&dataTerm=DAILY&pageNo=1&numOfRows=1&ver=1.3`)
    ])
    .then(responses => Promise.all(responses.map(res => res.json())))
    .then(([weatherData, dustData]) => {
      const items = weatherData.response.body.items.item;
      const summary = {}, detail = [];

      items.forEach(item => {
        if (item.category === 'T1H' && summaryTimes.includes(item.fcstTime)) {
          summary[item.fcstTime] = { temp: item.fcstValue };
        }
        if (item.category === 'REH' && detailTimes.includes(item.fcstTime)) {
          const timeSlot = detail.find(d => d.time === item.fcstTime) || { time: item.fcstTime };
          timeSlot.humidity = item.fcstValue;
          if (!detail.includes(timeSlot)) detail.push(timeSlot);
        }
        if (item.category === 'SKY' && summaryTimes.includes(item.fcstTime)) {
          const code = parseInt(item.fcstValue);
          const condition = code === 1 ? '맑음' : code === 3 ? '구름 많음' : '흐림';
          summary[item.fcstTime].condition = condition;
        }
        if (item.category === 'PTY' && summaryTimes.includes(item.fcstTime)) {
          if (parseInt(item.fcstValue) === 1) summary[item.fcstTime].condition = '비';
          if (parseInt(item.fcstValue) === 3) summary[item.fcstTime].condition = '눈';
        }
        if (item.category === 'T1H' && detailTimes.includes(item.fcstTime)) {
          const timeSlot = detail.find(d => d.time === item.fcstTime) || { time: item.fcstTime };
          timeSlot.temp = item.fcstValue;
          if (!detail.includes(timeSlot)) detail.push(timeSlot);
        }
      });

      const pm10 = dustData.response.body.items[0].pm10Value;
      const pm25 = dustData.response.body.items[0].pm25Value;

      const fullData = { summary, detail, pm10, pm25 };
      localStorage.setItem('weatherCache', JSON.stringify({ date: baseDate, data: fullData }));
      render(fullData);
    })
    .catch(() => {
      document.getElementById('loading').textContent = '날씨 정보를 불러오지 못했습니다.';
    });

    function render(data) {
      document.getElementById('loading').style.display = 'none';
      const summaryDiv = document.getElementById('weather-summary');
      const detailDiv = document.getElementById('weather-detail');

      summaryDiv.innerHTML = `<h2>[오늘 날씨]</h2>
        <p>미세먼지: ${data.pm10}㎍/㎥, 초미세먼지: ${data.pm25}㎍/㎥</p>
        <div>${Object.entries(data.summary).map(([time, info]) =>
          `<div>
             <img src="images/${icons[info.condition] || 'unknown.png'}" alt="${info.condition}" style="height:40px;vertical-align:middle;"/>
             ${time.slice(0,2)}시: ${info.temp}℃ / ${info.condition}
           </div>`).join('')}</div>`;

      detailDiv.innerHTML = `<h2>[오늘 날씨 세부 정보]</h2>
        <ul>${data.detail.map(d =>
          `<li>${d.time.slice(0,2)}시 - 온도: ${d.temp}℃, 습도: ${d.humidity}%</li>`).join('')}</ul>`;
    }
  </script>
</body>
</html>
