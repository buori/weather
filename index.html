<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>동탄의 날씨</title>
  <style>
    body {
      font-family: '맑은 고딕', sans-serif;
      text-align: center;
      padding: 20px;
    }
    #loading {
      margin-top: 30px;
    }
    #content {
      display: none;
    }
    .weather-box {
      display: inline-block;
      width: 200px;
      margin: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
    .weather-box img {
      width: 100px;
      height: 100px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    th {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <h1 id="page-title">동탄의 날씨</h1>
  <div id="loading">
    <p>🌤️ 날씨 정보를 불러오는 중... (최대 3~4분 소요될 수 있습니다)</p>
  </div>
  <div id="content">
    <div id="summary-weather"></div>
    <h2>오늘 시간대별 날씨</h2>
    <div id="hourly-weather"></div>
  </div>

  <script>
    const weatherImages = {
      '맑음': 'sunny.png',
      '구름많음': 'cloudy.png',
      '흐림': 'overcast.png',
      '비': 'rain.png',
      '눈': 'snow.png',
      '없음': 'unknown.png'
    };

    const skyCodes = {
      1: '맑음',
      3: '구름많음',
      4: '흐림'
    };

    const ptyCodes = {
      0: '없음',
      1: '비',
      2: '비/눈',
      3: '눈',
      4: '소나기'
    };

    const hours = ['01', '04', '07', '10', '13', '16', '19', '22'];

    async function fetchWeather() {
      const serviceKey = 'UX0oUh7ZWRuQW2qnng2rzw8U14zs2TmY9DYi8Eqs0SDQpo1wMe0l/BtVqaYcl7LYEJP0wysrk3xmQFgeE5iTJQ==';
      const dustApiKey = 'UX0oUh7ZWRuQW2qnng2rzw8U14zs2TmY9DYi8Eqs0SDQpo1wMe0l/BtVqaYcl7LYEJP0wysrk3xmQFgeE5iTJQ==
';
      const baseDate = getBaseDate();
      const baseTime = '0500';
      const nx = 61;
      const ny = 120;

      const weatherUrl = `https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst?serviceKey=${serviceKey}&pageNo=1&numOfRows=1000&dataType=JSON&base_date=${baseDate}&base_time=${baseTime}&nx=${nx}&ny=${ny}`;

      try {
        const [weatherResponse, dustResponse] = await Promise.all([
          fetch(weatherUrl),
          fetch(`https://apis.data.go.kr/B552584/ArpltnInforInqireSvc/getMsrstnAcctoRltmMesureDnsty?serviceKey=${dustApiKey}&returnType=json&numOfRows=1&pageNo=1&stationName=%EB%8F%99%ED%83%84%EA%B5%AC&dataTerm=DAILY&ver=1.0`)
        ]);

        const weatherData = await weatherResponse.json();
        const dustData = await dustResponse.json();

        const weatherItems = weatherData.response.body.items.item;
        const dustItem = dustData.response.body.items[0];

        const data = processWeatherData(weatherItems);
        displaySummaryWeather(data, dustItem);
        displayHourlyWeather(data['오늘']);

      } catch (error) {
        console.error('데이터 불러오기 실패:', error);
      } finally {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
      }
    }

    function getBaseDate() {
      const now = new Date();
      now.setHours(now.getHours() - 1);
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      return `${year}${month}${day}`;
    }

    function processWeatherData(items) {
      const data = { '오늘': {}, '내일': {}, '모레': {} };
      const dateMap = {};
      const today = new Date();

      for (let i = 0; i < 3; i++) {
        const d = new Date(today);
        d.setDate(today.getDate() + i);
        const key = `${d.getFullYear()}${String(d.getMonth() + 1).padStart(2, '0')}${String(d.getDate()).padStart(2, '0')}`;
        const label = i === 0 ? '오늘' : i === 1 ? '내일' : '모레';
        dateMap[key] = label;
      }

      items.forEach(item => {
        const { fcstDate, fcstTime, category, fcstValue } = item;
        const label = dateMap[fcstDate];
        if (label) {
          if (!data[label][fcstTime]) data[label][fcstTime] = {};
          data[label][fcstTime][category] = fcstValue;
        }
      });
      return data;
    }

    function displaySummaryWeather(data, dust) {
      const container = document.getElementById('summary-weather');
      container.innerHTML = '';
      for (const [label, times] of Object.entries(data)) {
        const time = Object.keys(times)[0];
        const info = times[time];
        const sky = skyCodes[info.SKY] || '맑음';
        const pty = ptyCodes[info.PTY] || '없음';
        const weather = pty !== '없음' ? pty : sky;
        const image = weatherImages[weather] || 'unknown.png';
        const temp = info.TMP;

        const box = document.createElement('div');
        box.className = 'weather-box';
        box.innerHTML = `
          <h3>${label}</h3>
          <img src="images/${image}" alt="${weather}" />
          <p>${weather}</p>
          <p>${temp}℃</p>
          ${label === '오늘' ? `<p>미세먼지: ${dust.pm10Value}㎍/㎥</p><p>초미세먼지: ${dust.pm25Value}㎍/㎥</p>` : ''}
        `;
        container.appendChild(box);
      }
    }

    function displayHourlyWeather(todayData) {
      const container = document.getElementById('hourly-weather');
      const table = document.createElement('table');
      table.innerHTML = `
        <tr>
          <th>시간</th>
          <th>기온(℃)</th>
          <th>날씨</th>
          <th>습도(%)</th>
        </tr>
      `;

      hours.forEach(hour => {
        const time = `${hour}00`;
        const data = todayData[time];
        if (data) {
          const sky = skyCodes[data.SKY] || '맑음';
          const pty = ptyCodes[data.PTY] || '없음';
          const weather = pty !== '없음' ? pty : sky;
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${hour}시</td>
            <td>${data.TMP}</td>
            <td>${weather}</td>
            <td>${data.REH}</td>
          `;
          table.appendChild(row);
        }
      });

      container.appendChild(table);
    }

    fetchWeather();
  </script>
</body>
</html>
