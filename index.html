<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë™íƒ„ì˜ ë‚ ì”¨</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2em; }
    .loading { font-size: 1.2em; margin-top: 2em; }
    .weather-container { display: flex; justify-content: space-around; margin-top: 2em; flex-wrap: wrap; }
    .weather-box { border: 1px solid #ccc; border-radius: 10px; padding: 1em; width: 250px; margin: 1em; box-shadow: 2px 2px 6px rgba(0,0,0,0.1); }
    .weather-box img { width: 80px; height: 80px; }
    .title { font-size: 1.5em; margin-bottom: 0.5em; }
  </style>
</head>
<body>
  <h1>ğŸŒ¤ï¸ ë™íƒ„ì˜ ë‚ ì”¨</h1>
  <div class="loading" id="loading">ğŸŒ¤ï¸ ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... (ìµœëŒ€ 3~4ë¶„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)</div>
  <div class="weather-container" id="weather-container" style="display:none;"></div>

  <script>
    const WEATHER_API_KEY = "UX0oUh7ZWRuQW2qnng2rzw8U14zs2TmY9DYi8Eqs0SDQpo1wMe0l/BtVqaYcl7LYEJP0wysrk3xmQFgeE5iTJQ==";
    const AIR_API_KEY = "UX0oUh7ZWRuQW2qnng2rzw8U14zs2TmY9DYi8Eqs0SDQpo1wMe0l/BtVqaYcl7LYEJP0wysrk3xmQFgeE5iTJQ==
";

    const WEATHER_IMG = {
      1: "sunny.png",
      3: "cloudy.png",
      4: "overcast.png",
      "ë¹„": "rain.png",
      "ëˆˆ": "snow.png",
      "ë¹„/ëˆˆ": "snow.png",
      "ì•Œ ìˆ˜ ì—†ìŒ": "unknown.png"
    };

    const getDateStr = (offset) => {
      const date = new Date();
      date.setDate(date.getDate() + offset);
      return date.toISOString().split("T")[0];
    };

    const getWeatherImage = (sky, pty) => {
      if (pty !== "0") {
        if (["1", "4"].includes(pty)) return WEATHER_IMG["ë¹„"];
        if (["2", "3"].includes(pty)) return WEATHER_IMG["ëˆˆ"];
        return WEATHER_IMG["ì•Œ ìˆ˜ ì—†ìŒ"];
      }
      return WEATHER_IMG[sky] || WEATHER_IMG["ì•Œ ìˆ˜ ì—†ìŒ"];
    };

    const fetchAirQuality = async () => {
      try {
        const res = await fetch(`https://apis.data.go.kr/B552584/ArpltnInforInqireSvc/getCtprvnRltmMesureDnsty?serviceKey=${AIR_API_KEY}&returnType=json&numOfRows=100&pageNo=1&sidoName=ê²½ê¸°&ver=1.0`);
        const data = await res.json();
        const dongtan = data.response.body.items.find(item => item.stationName.includes("ë™íƒ„"));
        return {
          PM10: dongtan.pm10Value ?? "ì•Œ ìˆ˜ ì—†ìŒ",
          PM25: dongtan.pm25Value ?? "ì•Œ ìˆ˜ ì—†ìŒ"
        };
      } catch (error) {
        console.error("ë¯¸ì„¸ë¨¼ì§€ ì •ë³´ ì‹¤íŒ¨:", error);
        return {
          PM10: "ì•Œ ìˆ˜ ì—†ìŒ",
          PM25: "ì•Œ ìˆ˜ ì—†ìŒ"
        };
      }
    };

    const fetchWeather = async () => {
      const container = document.getElementById("weather-container");
      const loading = document.getElementById("loading");

      try {
        const baseDate = new Date();
        const dateStr = baseDate.toISOString().slice(0,10).replace(/-/g, '');
        const baseTime = "0500";
        const nx = 61, ny = 120; // ë™íƒ„ ê²©ì ì¢Œí‘œ

        const res = await fetch(`https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst?serviceKey=${WEATHER_API_KEY}&pageNo=1&numOfRows=1000&dataType=JSON&base_date=${dateStr}&base_time=${baseTime}&nx=${nx}&ny=${ny}`);
        const data = await res.json();

        const items = data.response.body.items.item;
        const weatherByDate = {};

        for (let offset = 0; offset <= 2; offset++) {
          const date = getDateStr(offset).replace(/-/g, '');
          weatherByDate[date] = {
            TMP: null, SKY: null, PTY: "0", REH: null, WSD: null,
            PM10: "ë¡œë”© ì¤‘", PM25: "ë¡œë”© ì¤‘"
          };
        }

        items.forEach(item => {
          const fcstDate = item.fcstDate;
          const category = item.category;
          if (weatherByDate[fcstDate] && weatherByDate[fcstDate][category] === null) {
            weatherByDate[fcstDate][category] = item.fcstValue;
          }
        });

        // ë¯¸ì„¸ë¨¼ì§€ ë¶ˆëŸ¬ì˜¤ê¸°
        const airQuality = await fetchAirQuality();
        for (let date in weatherByDate) {
          weatherByDate[date].PM10 = airQuality.PM10;
          weatherByDate[date].PM25 = airQuality.PM25;
        }

        const labels = ["ì˜¤ëŠ˜ ë‚ ì”¨", "ë‚´ì¼ ë‚ ì”¨", "ëª¨ë ˆ ë‚ ì”¨"];
        let i = 0;

        for (let key of Object.keys(weatherByDate)) {
          const w = weatherByDate[key];
          const image = getWeatherImage(w.SKY, w.PTY);
          container.innerHTML += `
            <div class="weather-box">
              <div class="title">${labels[i]}</div>
              <img src="images/${image}" alt="ë‚ ì”¨ ì•„ì´ì½˜" />
              <div>ğŸŒ¡ï¸ ì˜¨ë„: ${w.TMP ?? "-"}â„ƒ</div>
              <div>ğŸŒ¥ï¸ í•˜ëŠ˜ ìƒíƒœ: ${w.SKY}</div>
              <div>ğŸ’§ ìŠµë„: ${w.REH ?? "-"}%</div>
              <div>ğŸƒ í’ì†: ${w.WSD ?? "-"} m/s</div>
              <div>ğŸŒ«ï¸ ë¯¸ì„¸ë¨¼ì§€: ${w.PM10}</div>
              <div>ğŸŒ ì´ˆë¯¸ì„¸ë¨¼ì§€: ${w.PM25}</div>
            </div>
          `;
          i++;
        }

        loading.style.display = "none";
        container.style.display = "flex";

      } catch (error) {
        console.error("ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨:", error);
        loading.innerText = "âŒ ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
      }
    };

    window.onload = fetchWeather;
  </script>
</body>
</html>
