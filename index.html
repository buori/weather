<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë™íƒ„ì˜ ë‚ ì”¨</title>
  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
    h1, h2 { text-align: center; }
    #summary-weather > div {
      display: inline-block;
      width: 30%;
      text-align: center;
      margin: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
    }
    #hourly-weather > div {
      margin: 6px 0;
    }
    img { width: 60px; height: 60px; }
  </style>
</head>
<body>
  <h1>ë™íƒ„ì˜ ë‚ ì”¨</h1>

  <!-- ë¡œë”© ì¤‘ -->
  <div id="loading" style="text-align:center; margin: 20px;">
    ğŸŒ¤ï¸ ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... (ìµœëŒ€ 3~4ë¶„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)
  </div>

  <!-- ë‚ ì”¨ ë°ì´í„° -->
  <div id="content" style="display: none;">
    <div id="summary-weather"></div>
    <div id="detailed-weather">
      <h2>ì˜¤ëŠ˜ ì‹œê°„ëŒ€ë³„ ë‚ ì”¨</h2>
      <div id="hourly-weather"></div>
    </div>
  </div>

  <script>
    function getBaseTime() {
      const now = new Date();
      const hour = now.getHours();
      const baseTimes = ["0200", "0500", "0800", "1100", "1400", "1700", "2000", "2300"];
      const index = Math.floor(hour / 3) - 1;
      return baseTimes[Math.max(index, 0)];
    }

    function getWeatherImage(sky, pty) {
      if (pty === "1" || pty === "4") return "images/rain.png";
      if (pty === "2" || pty === "3") return "images/snow.png";
      if (sky === "1") return "images/sunny.png";
      if (sky === "3" || sky === "4") return "images/cloudy.png";
      return "images/unknown.png";
    }

    function skyText(sky, pty) {
      if (pty === "1" || pty === "4") return "ë¹„";
      if (pty === "2") return "ë¹„/ëˆˆ";
      if (pty === "3") return "ëˆˆ";
      if (sky === "1") return "ë§‘ìŒ";
      if (sky === "3" || sky === "4") return "íë¦¼";
      return "ì •ë³´ ì—†ìŒ";
    }

    async function fetchWeather() {
      const serviceKey = "UX0oUh7ZWRuQW2qnng2rzw8U14zs2TmY9DYi8Eqs0SDQpo1wMe0l/BtVqaYcl7LYEJP0wysrk3xmQFgeE5iTJQ=="; // ğŸ‘‰ ë°˜ë“œì‹œ ë³¸ì¸ì˜ API í‚¤ë¡œ ëŒ€ì²´
      const nx = 60, ny = 120; // ë™íƒ„
      const now = new Date();
      const baseDate = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
      const baseTime = getBaseTime();

      const url = `https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst?serviceKey=${serviceKey}&pageNo=1&numOfRows=1000&dataType=JSON&base_date=${baseDate}&base_time=${baseTime}&nx=${nx}&ny=${ny}`;

      try {
        const res = await fetch(url);
        const json = await res.json();
        const items = json.response.body.items.item;

        // ìš”ì•½ ë‚ ì”¨ (ì˜¤ëŠ˜/ë‚´ì¼/ëª¨ë ˆ)
        const summaryContainer = document.getElementById("summary-weather");
        const days = ["ì˜¤ëŠ˜", "ë‚´ì¼", "ëª¨ë ˆ"];
        for (let i = 0; i < 3; i++) {
          const date = new Date();
          date.setDate(date.getDate() + i);
          const dateStr = `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}`;
          const data = items.filter(item => item.fcstDate === dateStr && item.fcstTime === "1500");

          const sky = data.find(i => i.category === "SKY")?.fcstValue;
          const pty = data.find(i => i.category === "PTY")?.fcstValue;
          const tmp = data.find(i => i.category === "TMP")?.fcstValue;

          const box = document.createElement("div");
          box.innerHTML = `
            <h3>${days[i]} ë‚ ì”¨</h3>
            <img src="${getWeatherImage(sky, pty)}" alt="">
            <p>${skyText(sky, pty)}</p>
            <p>ê¸°ì˜¨: ${tmp ?? '-'}â„ƒ</p>
          `;
          summaryContainer.appendChild(box);
        }

        // ì‹œê°„ëŒ€ë³„ ë‚ ì”¨ (ì˜¤ëŠ˜)
        const hourlyContainer = document.getElementById("hourly-weather");
        const hours = ["0100", "0400", "0700", "1000", "1300", "1600", "1900", "2200"];
        for (const time of hours) {
          const data = items.filter(item => item.fcstDate === baseDate && item.fcstTime === time);
          const tmp = data.find(i => i.category === "TMP")?.fcstValue;
          const sky = data.find(i => i.category === "SKY")?.fcstValue;
          const pty = data.find(i => i.category === "PTY")?.fcstValue;
          const reh = data.find(i => i.category === "REH")?.fcstValue;

          const row = document.createElement("div");
          row.innerHTML = `<strong>${time.slice(0, 2)}ì‹œ</strong> | ê¸°ì˜¨: ${tmp ?? '-'}â„ƒ | ë‚ ì”¨: ${skyText(sky, pty)} | ìŠµë„: ${reh ?? '-'}%`;
          hourlyContainer.appendChild(row);
        }

      } catch (err) {
        console.error("ë‚ ì”¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", err);
      } finally {
        document.getElementById("loading").style.display = "none";
        document.getElementById("content").style.display = "block";
      }
    }

    fetchWeather();
  </script>
</body>
</html>
