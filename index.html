<body>
  <h1 id="page-title"></h1>

  <!-- 날씨 요약 영역 -->
  <div id="summary-weather"></div>

  <!-- 오늘 세부 정보 영역 -->
  <div id="detailed-weather">
    <h2>오늘 시간대별 날씨</h2>
    <div id="hourly-weather"></div>
  </div>

  <script>
    function setTitleWithDate() {
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      document.getElementById("page-title").textContent = `${yyyy}-${mm}-${dd}의 동탄 날씨`;
    }

    function formatDate(date) {
      const yyyy = date.getFullYear();
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      return `${yyyy}${dd}${mm}`;
    }

    function getBaseTime() {
      const now = new Date();
      const hour = now.getHours();
      const baseTimes = ["0200", "0500", "0800", "1100", "1400", "1700", "2000", "2300"];
      const baseIndex = Math.floor(hour / 3);
      return baseTimes[Math.max(baseIndex - 1, 0)];
    }

    function getWeatherImage(sky, pty) {
      if (pty === "1" || pty === "4") return "rain.png";
      if (pty === "2" || pty === "3") return "snow.png";
      if (sky === "1") return "sunny.png";
      if (sky === "3") return "cloudy.png";
      if (sky === "4") return "overcast.png";
      return "unknown.png";
    }

    function skyText(sky, pty) {
      if (pty === "1" || pty === "4") return "비";
      if (pty === "2") return "비/눈";
      if (pty === "3") return "눈";
      if (sky === "1") return "맑음";
      if (sky === "3") return "구름 많음";
      if (sky === "4") return "흐림";
      return "정보 없음";
    }

    async function fetchWeather() {
      const now = new Date();
      const baseDate = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
      const baseTime = getBaseTime();
      const serviceKey = "당신의_서비스키"; // 여기에 실제 키 입력
      const nx = 60, ny = 120;
      const url = `https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst?serviceKey=${serviceKey}&pageNo=1&numOfRows=1000&dataType=JSON&base_date=${baseDate}&base_time=${baseTime}&nx=${nx}&ny=${ny}`;
      const res = await fetch(url);
      const json = await res.json();
      const items = json.response.body.items.item;

      // 요약 날씨
      const summaryContainer = document.getElementById("summary-weather");
      summaryContainer.innerHTML = "";

      const times = ["오늘", "내일", "모레"];
      for (let i = 0; i < 3; i++) {
        const d = new Date();
        d.setDate(d.getDate() + i);
        const dateStr = `${d.getFullYear()}${String(d.getMonth() + 1).padStart(2, '0')}${String(d.getDate()).padStart(2, '0')}`;
        const dailyItems = items.filter(i => i.fcstDate === dateStr && i.fcstTime === "1500");

        const tmp = dailyItems.find(i => i.category === "TMP");
        const sky = dailyItems.find(i => i.category === "SKY");
        const pty = dailyItems.find(i => i.category === "PTY");

        const box = document.createElement("div");
        box.innerHTML = `
          <h3>${times[i]} 날씨</h3>
          <img src="images/${getWeatherImage(sky?.fcstValue, pty?.fcstValue)}" alt="">
          <p>${skyText(sky?.fcstValue, pty?.fcstValue)}</p>
          <p>기온: ${tmp?.fcstValue}℃</p>
        `;
        summaryContainer.appendChild(box);
      }

      // 오늘 시간대별 상세
      const hourlyContainer = document.getElementById("hourly-weather");
      const hours = ["0100", "0400", "0700", "1000", "1300", "1600", "1900", "2200"];
      hourlyContainer.innerHTML = "";

      for (const h of hours) {
        const detailItems = items.filter(i => i.fcstDate === baseDate && i.fcstTime === h);
        const tmp = detailItems.find(i => i.category === "TMP");
        const sky = detailItems.find(i => i.category === "SKY");
        const pty = detailItems.find(i => i.category === "PTY");
        const reh = detailItems.find(i => i.category === "REH");

        const row = document.createElement("div");
        row.innerHTML = `
          <strong>${h.slice(0, 2)}시</strong> | 기온: ${tmp?.fcstValue ?? '-'}℃ | 날씨: ${skyText(sky?.fcstValue, pty?.fcstValue)} | 습도: ${reh?.fcstValue ?? '-'}%
        `;
        hourlyContainer.appendChild(row);
      }
    }

    setTitleWithDate();
    fetchWeather();
  </script>
</body>
