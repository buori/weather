<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>동탄의 날씨</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2em; }
    .loading { font-size: 1.2em; margin-top: 2em; }
    .weather-container { display: flex; justify-content: space-around; margin-top: 2em; flex-wrap: wrap; }
    .weather-box { border: 1px solid #ccc; border-radius: 10px; padding: 1em; width: 250px; margin: 1em; box-shadow: 2px 2px 6px rgba(0,0,0,0.1); }
    .weather-box img { width: 80px; height: 80px; }
    .title { font-size: 1.5em; margin-bottom: 0.5em; }
  </style>
</head>
<body>
  <h1>🌤️ 동탄의 날씨</h1>
  <div class="loading" id="loading">🌤️ 날씨 정보를 불러오는 중... (최대 3~4분 소요될 수 있습니다)</div>
  <div class="weather-container" id="weather-container" style="display:none;"></div>

  <script>
    const WEATHER_API_KEY = "UX0oUh7ZWRuQW2qnng2rzw8U14zs2TmY9DYi8Eqs0SDQpo1wMe0l/BtVqaYcl7LYEJP0wysrk3xmQFgeE5iTJQ=="; // 기상청 API 키

    const WEATHER_IMG = {
      1: "sunny.png",
      3: "cloudy.png",
      4: "overcast.png",
      "비": "rain.png",
      "눈": "snow.png",
      "비/눈": "snow.png",
      "알 수 없음": "unknown.png"
    };

    const getDateStr = (offset) => {
      const date = new Date();
      date.setDate(date.getDate() + offset);
      return date.toISOString().split("T")[0];
    };

    const getWeatherImage = (sky, pty) => {
      if (pty !== "0") {
        if (["1", "4"].includes(pty)) return WEATHER_IMG["비"];
        if (["2", "3"].includes(pty)) return WEATHER_IMG["눈"];
        return WEATHER_IMG["알 수 없음"];
      }
      return WEATHER_IMG[sky] || WEATHER_IMG["알 수 없음"];
    };

    const fetchWeather = async () => {
      const container = document.getElementById("weather-container");
      const loading = document.getElementById("loading");

      try {
        const baseDate = new Date();
        const dateStr = baseDate.toISOString().slice(0,10).replace(/-/g, '');
        const baseTime = "0500";
        const nx = 61, ny = 120; // 동탄 격자 좌표

        const res = await fetch(`https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst?serviceKey=${WEATHER_API_KEY}&pageNo=1&numOfRows=1000&dataType=JSON&base_date=${dateStr}&base_time=${baseTime}&nx=${nx}&ny=${ny}`);
        const data = await res.json();

        const items = data.response.body.items.item;
        const weatherByDate = {};

        for (let offset = 0; offset <= 2; offset++) {
          const date = getDateStr(offset).replace(/-/g, '');
          weatherByDate[date] = {
            TMP: null, SKY: null, PTY: "0", REH: null, WSD: null
          };
        }

        items.forEach(item => {
          const fcstDate = item.fcstDate;
          const category = item.category;
          if (weatherByDate[fcstDate] && weatherByDate[fcstDate][category] === null) {
            weatherByDate[fcstDate][category] = item.fcstValue;
          }
        });

        const labels = ["오늘 날씨", "내일 날씨", "모레 날씨"];
        let i = 0;

        for (let key of Object.keys(weatherByDate)) {
          const w = weatherByDate[key];
          const image = getWeatherImage(w.SKY, w.PTY);
          container.innerHTML += `
            <div class="weather-box">
              <div class="title">${labels[i]}</div>
              <img src="images/${image}" alt="날씨 아이콘" />
              <div>🌡️ 온도: ${w.TMP ?? "-"}℃</div>
              <div>🌥️ 하늘 상태: ${w.SKY}</div>
              <div>💧 습도: ${w.REH ?? "-"}%</div>
              <div>🍃 풍속: ${w.WSD ?? "-"} m/s</div>
            </div>
          `;
          i++;
        }

        loading.style.display = "none";
        container.style.display = "flex";

      } catch (error) {
        console.error("날씨 정보를 불러오는 데 실패:", error);
        loading.innerText = "❌ 날씨 정보를 불러오는 데 실패했습니다.";
      }
    };

    window.onload = fetchWeather;
  </script>
</body>
</html>
