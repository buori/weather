<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë™íƒ„ì˜ ë‚ ì”¨</title>
  <style>
    body {
      font-family: 'ë§‘ì€ ê³ ë”•', sans-serif;
      text-align: center;
      padding: 20px;
    }
    #loading {
      margin-top: 30px;
    }
    #content {
      display: none;
    }
    .weather-box {
      display: inline-block;
      width: 200px;
      margin: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
    .weather-box img {
      width: 100px;
      height: 100px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    th {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <h1 id="page-title">ë™íƒ„ì˜ ë‚ ì”¨</h1>
  <div id="loading">
    <p>ğŸŒ¤ï¸ ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... (ìµœëŒ€ 3~4ë¶„ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)</p>
  </div>
  <div id="content">
    <div id="summary-weather"></div>
    <h2>ì˜¤ëŠ˜ ì‹œê°„ëŒ€ë³„ ë‚ ì”¨</h2>
    <div id="hourly-weather"></div>
  </div>

  <script>
    const weatherImages = {
      'ë§‘ìŒ': 'sunny.png',
      'êµ¬ë¦„ë§ìŒ': 'cloudy.png',
      'íë¦¼': 'overcast.png',
      'ë¹„': 'rain.png',
      'ëˆˆ': 'snow.png',
      'ì—†ìŒ': 'unknown.png'
    };

    const skyCodes = {
      1: 'ë§‘ìŒ',
      3: 'êµ¬ë¦„ë§ìŒ',
      4: 'íë¦¼'
    };

    const ptyCodes = {
      0: 'ì—†ìŒ',
      1: 'ë¹„',
      2: 'ë¹„/ëˆˆ',
      3: 'ëˆˆ',
      4: 'ì†Œë‚˜ê¸°'
    };

    const hours = ['01', '04', '07', '10', '13', '16', '19', '22'];

    async function fetchWeather() {
      const serviceKey = 'UX0oUh7ZWRuQW2qnng2rzw8U14zs2TmY9DYi8Eqs0SDQpo1wMe0l/BtVqaYcl7LYEJP0wysrk3xmQFgeE5iTJQ==';
      const dustApiKey = 'UX0oUh7ZWRuQW2qnng2rzw8U14zs2TmY9DYi8Eqs0SDQpo1wMe0l/BtVqaYcl7LYEJP0wysrk3xmQFgeE5iTJQ==
';
      const baseDate = getBaseDate();
      const baseTime = '0500';
      const nx = 61;
      const ny = 120;

      const weatherUrl = `https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst?serviceKey=${serviceKey}&pageNo=1&numOfRows=1000&dataType=JSON&base_date=${baseDate}&base_time=${baseTime}&nx=${nx}&ny=${ny}`;

      try {
        const [weatherResponse, dustResponse] = await Promise.all([
          fetch(weatherUrl),
          fetch(`https://apis.data.go.kr/B552584/ArpltnInforInqireSvc/getMsrstnAcctoRltmMesureDnsty?serviceKey=${dustApiKey}&returnType=json&numOfRows=1&pageNo=1&stationName=%EB%8F%99%ED%83%84%EA%B5%AC&dataTerm=DAILY&ver=1.0`)
        ]);

        const weatherData = await weatherResponse.json();
        const dustData = await dustResponse.json();

        const weatherItems = weatherData.response.body.items.item;
        const dustItem = dustData.response.body.items[0];

        const data = processWeatherData(weatherItems);
        displaySummaryWeather(data, dustItem);
        displayHourlyWeather(data['ì˜¤ëŠ˜']);

      } catch (error) {
        console.error('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
      } finally {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
      }
    }

    function getBaseDate() {
      const now = new Date();
      now.setHours(now.getHours() - 1);
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      return `${year}${month}${day}`;
    }

    function processWeatherData(items) {
      const data = { 'ì˜¤ëŠ˜': {}, 'ë‚´ì¼': {}, 'ëª¨ë ˆ': {} };
      const dateMap = {};
      const today = new Date();

      for (let i = 0; i < 3; i++) {
        const d = new Date(today);
        d.setDate(today.getDate() + i);
        const key = `${d.getFullYear()}${String(d.getMonth() + 1).padStart(2, '0')}${String(d.getDate()).padStart(2, '0')}`;
        const label = i === 0 ? 'ì˜¤ëŠ˜' : i === 1 ? 'ë‚´ì¼' : 'ëª¨ë ˆ';
        dateMap[key] = label;
      }

      items.forEach(item => {
        const { fcstDate, fcstTime, category, fcstValue } = item;
        const label = dateMap[fcstDate];
        if (label) {
          if (!data[label][fcstTime]) data[label][fcstTime] = {};
          data[label][fcstTime][category] = fcstValue;
        }
      });
      return data;
    }

    function displaySummaryWeather(data, dust) {
      const container = document.getElementById('summary-weather');
      container.innerHTML = '';
      for (const [label, times] of Object.entries(data)) {
        const time = Object.keys(times)[0];
        const info = times[time];
        const sky = skyCodes[info.SKY] || 'ë§‘ìŒ';
        const pty = ptyCodes[info.PTY] || 'ì—†ìŒ';
        const weather = pty !== 'ì—†ìŒ' ? pty : sky;
        const image = weatherImages[weather] || 'unknown.png';
        const temp = info.TMP;

        const box = document.createElement('div');
        box.className = 'weather-box';
        box.innerHTML = `
          <h3>${label}</h3>
          <img src="images/${image}" alt="${weather}" />
          <p>${weather}</p>
          <p>${temp}â„ƒ</p>
          ${label === 'ì˜¤ëŠ˜' ? `<p>ë¯¸ì„¸ë¨¼ì§€: ${dust.pm10Value}ã/ã¥</p><p>ì´ˆë¯¸ì„¸ë¨¼ì§€: ${dust.pm25Value}ã/ã¥</p>` : ''}
        `;
        container.appendChild(box);
      }
    }

    function displayHourlyWeather(todayData) {
      const container = document.getElementById('hourly-weather');
      const table = document.createElement('table');
      table.innerHTML = `
        <tr>
          <th>ì‹œê°„</th>
          <th>ê¸°ì˜¨(â„ƒ)</th>
          <th>ë‚ ì”¨</th>
          <th>ìŠµë„(%)</th>
        </tr>
      `;

      hours.forEach(hour => {
        const time = `${hour}00`;
        const data = todayData[time];
        if (data) {
          const sky = skyCodes[data.SKY] || 'ë§‘ìŒ';
          const pty = ptyCodes[data.PTY] || 'ì—†ìŒ';
          const weather = pty !== 'ì—†ìŒ' ? pty : sky;
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${hour}ì‹œ</td>
            <td>${data.TMP}</td>
            <td>${weather}</td>
            <td>${data.REH}</td>
          `;
          table.appendChild(row);
        }
      });

      container.appendChild(table);
    }

    fetchWeather();
  </script>
</body>
</html>
