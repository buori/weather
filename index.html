<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>동탄의 날씨</title>
  <style>
    body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
    h1, h2 { text-align: center; }
    #summary-weather > div {
      display: inline-block;
      width: 30%;
      text-align: center;
      margin: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
    }
    #hourly-weather > div {
      margin: 6px 0;
    }
    img { width: 60px; height: 60px; }
  </style>
</head>
<body>
  <h1>동탄의 날씨</h1>

  <!-- 로딩 중 -->
  <div id="loading" style="text-align:center; margin: 20px;">
    🌤️ 날씨 정보를 불러오는 중... (최대 3~4분 소요될 수 있습니다)
  </div>

  <!-- 날씨 데이터 -->
  <div id="content" style="display: none;">
    <div id="summary-weather"></div>
    <div id="detailed-weather">
      <h2>오늘 시간대별 날씨</h2>
      <div id="hourly-weather"></div>
    </div>
  </div>

  <script>
    function getBaseTime() {
      const now = new Date();
      const hour = now.getHours();
      const baseTimes = ["0200", "0500", "0800", "1100", "1400", "1700", "2000", "2300"];
      const index = Math.floor(hour / 3) - 1;
      return baseTimes[Math.max(index, 0)];
    }

    function getWeatherImage(sky, pty) {
      if (pty === "1" || pty === "4") return "images/rain.png";
      if (pty === "2" || pty === "3") return "images/snow.png";
      if (sky === "1") return "images/sunny.png";
      if (sky === "3" || sky === "4") return "images/cloudy.png";
      return "images/unknown.png";
    }

    function skyText(sky, pty) {
      if (pty === "1" || pty === "4") return "비";
      if (pty === "2") return "비/눈";
      if (pty === "3") return "눈";
      if (sky === "1") return "맑음";
      if (sky === "3" || sky === "4") return "흐림";
      return "정보 없음";
    }

    async function fetchWeather() {
      const serviceKey = "UX0oUh7ZWRuQW2qnng2rzw8U14zs2TmY9DYi8Eqs0SDQpo1wMe0l/BtVqaYcl7LYEJP0wysrk3xmQFgeE5iTJQ=="; // 👉 반드시 본인의 API 키로 대체
      const nx = 60, ny = 120; // 동탄
      const now = new Date();
      const baseDate = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`;
      const baseTime = getBaseTime();

      const url = `https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst?serviceKey=${serviceKey}&pageNo=1&numOfRows=1000&dataType=JSON&base_date=${baseDate}&base_time=${baseTime}&nx=${nx}&ny=${ny}`;

      try {
        const res = await fetch(url);
        const json = await res.json();
        const items = json.response.body.items.item;

        // 요약 날씨 (오늘/내일/모레)
        const summaryContainer = document.getElementById("summary-weather");
        const days = ["오늘", "내일", "모레"];
        for (let i = 0; i < 3; i++) {
          const date = new Date();
          date.setDate(date.getDate() + i);
          const dateStr = `${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}`;
          const data = items.filter(item => item.fcstDate === dateStr && item.fcstTime === "1500");

          const sky = data.find(i => i.category === "SKY")?.fcstValue;
          const pty = data.find(i => i.category === "PTY")?.fcstValue;
          const tmp = data.find(i => i.category === "TMP")?.fcstValue;

          const box = document.createElement("div");
          box.innerHTML = `
            <h3>${days[i]} 날씨</h3>
            <img src="${getWeatherImage(sky, pty)}" alt="">
            <p>${skyText(sky, pty)}</p>
            <p>기온: ${tmp ?? '-'}℃</p>
          `;
          summaryContainer.appendChild(box);
        }

        // 시간대별 날씨 (오늘)
        const hourlyContainer = document.getElementById("hourly-weather");
        const hours = ["0100", "0400", "0700", "1000", "1300", "1600", "1900", "2200"];
        for (const time of hours) {
          const data = items.filter(item => item.fcstDate === baseDate && item.fcstTime === time);
          const tmp = data.find(i => i.category === "TMP")?.fcstValue;
          const sky = data.find(i => i.category === "SKY")?.fcstValue;
          const pty = data.find(i => i.category === "PTY")?.fcstValue;
          const reh = data.find(i => i.category === "REH")?.fcstValue;

          const row = document.createElement("div");
          row.innerHTML = `<strong>${time.slice(0, 2)}시</strong> | 기온: ${tmp ?? '-'}℃ | 날씨: ${skyText(sky, pty)} | 습도: ${reh ?? '-'}%`;
          hourlyContainer.appendChild(row);
        }

      } catch (err) {
        console.error("날씨 데이터를 불러오지 못했습니다.", err);
      } finally {
        document.getElementById("loading").style.display = "none";
        document.getElementById("content").style.display = "block";
      }
    }

    fetchWeather();
  </script>
</body>
</html>
